# 网络层
## 功能
- 异构网络互连
- 路由选择与分组转发
- 网络层的两种服务：虚电路和数据报
- 软件定义网络SDN
    - 采用集中式的控制平面和分布式的数据平面
    - 北向接口：提供给开发者的编程接口；
    - 南向接口：用于转发设备和控制器之间的通信（OpenFlow）
    - 优点：集中式控制、灵活性高、降低成本
    - 缺点：瓶颈问题、安全性问题
- 拥塞控制

## IPv4
### IPv4分组
#### 格式
- 版本：4位，IPv4为4
- 首部长度：4位，以4B为单位，最小为5（20B），最大为15（60B）
- 总长度：16位，单位为B，最大为65535B；以太网MTU为1500B，不能超过该长度
- 标识：16位，用于分片重组
- 标志：3位
    - 中间位DF（Don't Fragment）：1表示不允许分片
    - 最低位MF（More Fragments）：1表示之后还有分片
- 片偏移：13位，单位为8B；除最后一个分片外，其他分片的长度必须是8B的整数倍
- 生存时间TTL：8位，路由器转发数据报**前**先将其-1
- 协议：8位，表示上层协议类型，如TCP（6）、UDP（17）、ICMP（1）
- 首部检验和：16位，只检测首部
- 源地址字段：32位
- 目的地址字段：32位

#### 数据报分片
- 分片条件：DF=0
- 分片会导致发生变化的首部字段：总长度、标志（MF）、片偏移、首部检验和

### IPv4与NAT
#### IPv4地址分类
- A类：0开头，1-126，8位网络号+24位主机号
- B类：10开头，128-191，16位网络号+16位主机号
- C类：110开头，192-223，24位网络号+8位主机号
- D类：1110开头，224-239，组播地址
- E类：1111开头，240-255，保留
- 特殊地址
    - **主机号**全0：表示该网络本身
    - 主机号全1：表示该网络上的所有主机（广播地址）
    - 127开头：环回地址
    - 32位全0：表示本网络上的本主机
    - 32位全1：受限广播地址，仅在本网络上传播

#### 网络地址转换NAT
- 私有地址范围
    - 10.0.0.0/8：相当于一个A类地址
    - 172.16.0.0/12：相当于16个B类地址
    - 192.168.0.0/16：相当于256个C类地址
- NAT工作原理：
    - 内网主机发送数据报时，NAT路由器将源地址替换为其公网地址，并记录内外地址和端口号的映射关系
    - 外网主机发送数据报时，NAT路由器根据目的地址和端口号查找映射关系，将目的地址替换为内网主机地址
- NAT路由器工作在网络层，但修改了传输层端口号，因此也涉及传输层

### 划分子网与路由聚合
- 三级地址结构：网络号-子网号-主机号
- 子网掩码：与IP地址按位与运算，得到网络号
- CIDR表示法：在IP地址后加斜杠和网络前缀长度，如192.168.1.0/24
- 路由聚合：将多个连续的网络号合并为一个更大的网络号，减少路由表项

### 分组转发过程
- 特定主机路由：子网掩码为32位
- 默认路由：0.0.0.0/0，通常用于转发到互联网
- 最长前缀匹配：选择与目的地址匹配的最长（最具体）网络前缀对应的路由表项
- 路由表项排序：按网络前缀长度从大到小排序，便于最长前缀匹配

## 协议
### 地址解析协议ARP（网络层）
- 功能：将IP地址解析为MAC地址
- 工作过程：
    - 通过MAC地址广播ARP请求，询问某IP地址对应的MAC地址
    - 拥有该IP地址的主机回复ARP响应（单播），提供其MAC地址
- ARP缓存：存储IP-MAC地址映射，减少ARP请求次数

### 动态主机配置协议DHCP（应用层/UDP）
- 功能：自动分配IP地址和其他网络参数
- 工作过程：
    - 需要IP地址的主机发送DHCP发现报文（广播）
    - DHCP服务器回复DHCP提供报文（广播），包含可用IP地址
    - 主机发送DHCP请求报文（广播），请求特定IP地址
    - DHCP服务器回复DHCP确认报文（广播），确认分配IP地址

### 网际控制报文协议ICMP（网络层）
- 功能：传递控制信息和错误报告
- 类型：
    - 终点不可达：路由器或主机不能交付数据报
    - 源点抑制：拥塞
    - 时间超过：TTL变为0，或终点在预定时间未收到所有报文片段
    - 参数问题：数据报首部某些字段有错误
    - 改变路由（重定向）：路由器建议主机使用更好的路由
- 常见报文类型：
    - 回送请求：测试主机可达性以及了解有关状态（分组网间探测ping）
    - 时间戳请求：利用时间戳测量往返时间（traceroute（追踪路由路径））
