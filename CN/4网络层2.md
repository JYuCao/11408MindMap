# 网络层2
## IPv6
### 知识点
- 解决IPv4地址耗尽问题
- 位数：128位（8部分*4*4）
- 特点：
    - 更大的地址空间，扩展的地址层次结构
    - 灵活的首部格式（且字段数比IPv4少，仅有8个）
    - 选项放在扩展首部中，允许协议继续扩展
    - 支持自动配置地址，无需DHCP
    - 支持资源预分配
    - 端到端，只有源主机和目的主机参与分片与重组
    - 增大安全性：扩展首部中支持身份鉴别和保密功能

### 首部格式
- 分为两部分：基本首部（固定40B）和有效载荷（由多个扩展首部组成）
- 基本首部字段：
    - 版本字段：4位，值为6
    - 通信量类：8位，用于区分不同数据报类别或优先级
    - 有效载荷长度字段：16位，表示扩展首部和数据部分的总长度
    - 下一个首部字段：8位，指示紧随基本首部之后的扩展首部类型
    - 跳数限制字段：8位，类似IPv4的TTL字段
    - 源地址字段：128位
    - 目的地址字段：128位

### 地址表示
- 全0压缩法：将连续的0段用“::”表示，但**只能使用一次**
- 前导0压缩法：每段前导的0可以省略
- 特殊地址表示法：
    - 未指明：::/128，表示未知地址
    - 环回地址：::1/128，表示本主机
    - 多播：ff00::/8，表示一组主机
    - 本地链路单播：fe80::/10，表示同一链路上的主机
- 全球单播地址格式：全球路由前缀（48位）+子网ID（16位）+接口标识符（64位）

### IPv4到IPv6的过渡
- 双栈技术：主机同时支持IPv4和IPv6协议栈
- 隧道技术：在IPv4网络中封装IPv6数据报进行传输

## 路由算法与协议
### 路由算法分类
- 静态路由：由网络管理员手动配置，适用于小型网络
- 动态路由：路由器自动学习和更新路由信息，适用于大型网络
    - 距离矢量路由算法：基于跳数或距离选择最短路径，常用协议有RIP
    - 链路状态路由算法：基于网络拓扑信息计算最短路径，常用协议有OSPF
- 内部网关协议（IGP）/外部网关协议（EGP）

### 距离矢量路由算法（RIP（应用层/UDP520））
- 自治系统AS内的每一个路由器都要维护从它自已到AS内其他每一个网络的距离记录
- RIP使用跳数(Hop Count)来衡量到达目的网络的距离
    - 路由器到直连网络的距离定义为1
    - 路由器到非直连网络的距离定义为所经过的路由器数加1
    - 允许一条路径最多只能包含15个路由器。“距离”等于16时相当于不可达。因此，RIP只适用于小型互联网
- RIP路由器仅与其直接相连的邻居路由器交换路由表（每隔**30秒**）
- 收敛：经过若干次路由更新后，所有路由器的路由表达到稳定状态
- 更新规则：
    - 发现了新的网络，添加
    - 到达目的网络，相同下一跳，最新消息，更新
    - 到达目的网络，不同下一跳，新路由优势，更新
    - 到达目的网络，不同下一跳，新路由劣势，不更新
    - 到达目的网络，不同下一跳，等价负载均衡
- 路由环路/距离无穷计数问题的解决方法：
    - 水平分割：定期将路由表中的某些信息删除
    - 触发更新：当路由器检测到某条路径不可达时，立即通知邻居路由器
    - 毒性逆转：当路由器收到某条路径不可达的信息时，将该路径的距离设置为16并传播出去

### 链路状态路由算法（OSPF（网络层/IP89））
#### 特点
- 不限制自治系统的大小，收敛更快
- 基于Dijkstra算法计算最短路径
- 链路状态：路由器和其直接相连的链路信息（代价：费用、距离、带宽、延迟等）

#### 链路状态通告、链路状态数据库与链路状态更新分组
- 链路状态通告（LSA）
    - 直连网络的链路状态
    - 邻居路由器的标识符
- 链路状态数据库（LSDB）：用于存储LSA
- 链路状态更新分组（LSU）：封装LSA并泛洪发送

#### 分组类型
- Hello报文：用于邻居发现和链路状态维护
- 数据库描述(Database Description)分组
- 链路状态请求(Link State Request)分组
- 链路状态更新(Link State Update)分组
- 链路状态确认(Link State Acknowledgment)分组

#### OSPF减少多播的方法
- 选举指定路由器(DR)和备份指定路由器(BDR)
- 所有非DR/BDR路由器只与DR和BDR交换LSA，互相之间通过DR/BDR间接传递信息
- 划分AS为多个区域，区域内路由器只维护本区域的LSDB

### 边界网关协议（BGP（传输层/TCP179））
- 基于路径向量的路由选择协议，用于不同自治系统之间的路由选择
- 格式：<CIDR前缀，BGP属性>
- AS-PATH属性：记录经过的AS序列，防止路由环路
- NEXT-HOP属性：指示到达目的网络的下一跳路由器
- BGP路由选择规则：
    1. 优先选择本地优先级最高的路径
    2. 优先选择AS-PATH最短的路径
    3. 热土豆路由：优先选择离本AS最近的出口路由器
    4. 优先选择BGP标识符最小的路径
- 报文：
    - 打开报文(Open)
    - 更新报文(Update)
    - 通知报文(Notification)
    - 保持连接报文(Keepalive)
- 会话：iBGP（同一AS内）和eBGP（不同AS间）

## 多播/组播
- 需要多播路由协议支持，
- 多播地址：D类地址（224.0.0.0 - 239.255.255.255）
- 硬件多播：
    - 多播MAC地址范围：01-00-5E-00-00-00到01-00-5E-7F-FF-FF
    - 多播MAC地址映射：将D类IP地址的低23位映射到多播MAC地址的低23位（**多对一**，D类由28位可用，但只映射23位）
- 网际组管理协议IGMP
    - 主机与路由器之间交换多播组成员信息
    - 报文类型：
        - 成员查询报文（查询多播组成员）
        - 成员报告报文（主机加入多播组时发送）
        - 离开报告报文（主机离开多播组时发送，IGMPv2及以后版本支持）

## 移动IP
- 移动站以固定IP地址实现跨网络漫游
- 主要实体：
    - 移动节点(MN)：具有永久IP地址的移动设备
    - 本地代理(HA)：连接在归属网络的路由器
    - 外地代理(FA)：连接在被访网络的路由器
- 外地代理的主要功能：
    - 为移动站创建一个临时的转交地址
    - 及时将移动站的转交地址通知给本地代理

## 网络层设备：路由器
- 路由选择（路由选择协议和路由表）和分组转发（转发表）
- 路由器结构
    - 输入端口：处理入接口的链路层协议，进行差错检测和数据包分类
    - 交换结构：根据路由表将数据包从输入端口转发到相应的输出端口
    - 输出端口：处理出接口的链路层协议，进行排队和调度
- 路由表项：目的网络地址、子网掩码、下一跳地址、接口
